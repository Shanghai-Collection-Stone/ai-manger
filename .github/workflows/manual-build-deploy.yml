name: manual-build-deploy

on:
  workflow_dispatch:
    inputs:
      deploy_path:
        description: 服务器Runner部署目录（包含或挂载docker专用配置）
        type: string
        required: true
        default: "/www/ace.root/ai-manger"
      env_file_path:
        description: 服务器Runner上的环境文件（可选）
        type: string
        required: false
        default: "/www/ace.root/ai-manger/.env"
      app_port:
        description: 对外端口映射到容器 3011
        type: string
        required: false
        default: "3011"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm globally
        run: |
          npm i -g pnpm@9
          echo "$(npm bin -g)" >> $GITHUB_PATH
          pnpm -v

      - name: Compute pnpm store path
        run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.PNPM_STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build NestJS
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-mvp-dist
          path: |
            dist
            package.json
            pnpm-lock.yaml
          retention-days: 1

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-mvp-dist
          path: ./artifact

      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare target directory
        run: |
          DP="${{ inputs.deploy_path }}"
          mkdir -p "$DP"
          rm -rf "$DP/dist"
          ARTIFACT_DIR="./artifact"
          if [ -d "./artifact/ai-mvp-dist" ]; then
            ARTIFACT_DIR="./artifact/ai-mvp-dist"
          fi
          echo "=== Artifact directory ==="
          echo "$ARTIFACT_DIR"
          ls -la "$ARTIFACT_DIR" | head -20

          cp -r "$ARTIFACT_DIR/dist" "$DP/"
          cp "$ARTIFACT_DIR/package.json" "$DP/"
          if [ -f "$ARTIFACT_DIR/pnpm-lock.yaml" ]; then
            cp "$ARTIFACT_DIR/pnpm-lock.yaml" "$DP/"
          fi

          HOST_PATH="${DP/\/www\/ace.root/\/www\/ace.c}"
          echo "=== Path mapping ==="
          echo "Runner container path: $DP"
          echo "Host machine path: $HOST_PATH"

      - name: Optional env file copy
        run: |
          SRC="${{ inputs.env_file_path }}"; DST="${{ inputs.deploy_path }}/.env"
          if [ -n "$SRC" ] && [ -f "$SRC" ] && [ "$SRC" != "$DST" ]; then
            cp -f "$SRC" "$DST"; fi

      - name: Place server docker yml
        run: |
          DP="${{ inputs.deploy_path }}"
          HOST_PATH="${DP/\/www\/ace.root/\/www\/ace.c}"
          cp -f server/docker-compose.yml "$DP/docker-compose.yml"
          sed -i "s#/www/ace.c/ai-manger#$HOST_PATH#g" "$DP/docker-compose.yml" || true

      - name: Verify files before docker run
        run: |
          DP="${{ inputs.deploy_path }}"
          ls -la "$DP" | head -50
          test -f "$DP/package.json" && echo "✓ package.json" || (echo "✗ package.json missing" && exit 1)
          test -f "$DP/pnpm-lock.yaml" && echo "✓ pnpm-lock.yaml" || echo "! pnpm-lock.yaml missing"
          test -f "$DP/dist/main.js" && echo "✓ dist/main.js" || (echo "✗ dist/main.js missing" && exit 1)

      - name: Rebuild and Redeploy Docker app
        run: |
          SERVICE="ai-mvp-app"
          DP="${{ inputs.deploy_path }}"

          APP_PORT="${{ inputs.app_port }}"; [ -z "$APP_PORT" ] && APP_PORT=3011
          export APP_PORT

          HOST_PATH="${DP/\/www\/ace.root/\/www\/ace.c}"

          echo "=== Path mapping ==="
          echo "Runner container path: $DP"
          echo "Host machine path: $HOST_PATH"
          echo ""

          echo "=== Verify host path exists ==="
          if [ -d "$HOST_PATH" ]; then
            echo "✓ Host path exists: $HOST_PATH"
            ls -la "$HOST_PATH" | head -10
          else
            echo "✗ Host path does NOT exist: $HOST_PATH"
          fi

          ENV_INPUT="${{ inputs.env_file_path }}"
          ENV_TARGET="$DP/.env"

          if [ -n "$ENV_INPUT" ] && [ -f "$ENV_INPUT" ]; then
            ENV_FILE="$ENV_INPUT"
          elif [ -f "$ENV_TARGET" ]; then
            ENV_FILE="$ENV_TARGET"
          else
            ENV_FILE=""
          fi

          if [ -n "$ENV_FILE" ]; then
            ENV_OPT=(--env-file "$ENV_FILE")
          else
            ENV_OPT=()
          fi

          if command -v docker >/dev/null 2>&1; then
            if [ -f "$DP/docker-compose.yml" ]; then
              echo "=== Using docker-compose ==="
              if docker compose version >/dev/null 2>&1; then
                docker compose -f "$DP/docker-compose.yml" --project-directory "$DP" up -d --build --force-recreate --remove-orphans
              elif command -v docker-compose >/dev/null 2>&1; then
                docker-compose -f "$DP/docker-compose.yml" up -d --build --force-recreate --remove-orphans
              else
                echo "docker compose not available"
                exit 1
              fi
            else
              echo "=== Using docker run ==="
              echo "Removing old container..."
              docker rm -f "$SERVICE" >/dev/null 2>&1 || true

              echo "Starting new container with volume: $HOST_PATH:/app"
              docker run "${ENV_OPT[@]}" -d --name "$SERVICE" -p "$APP_PORT":3011 \
                -e PORT=3011 -e NODE_ENV=production \
                -v "$HOST_PATH":/app \
                node:20-alpine sh -lc "npm i -g pnpm@9 && pnpm install --prod --frozen-lockfile && node dist/main.js"
            fi
          else
            echo "docker not found"
            exit 1
          fi

          echo ""
          echo "=== Waiting for container to start ==="
          sleep 3

          echo "=== Container logs ==="
          docker logs "$SERVICE" 2>&1 | tail -80 || true

      - name: Health check
        run: |
          PORT_VAL="${{ inputs.app_port }}"; [ -z "$PORT_VAL" ] && PORT_VAL=3011
          for i in $(seq 1 30); do
            if curl -fsS "http://localhost:${PORT_VAL}/" >/dev/null 2>&1; then exit 0; fi
            sleep 2;
          done;
          echo "App not healthy"; exit 1
