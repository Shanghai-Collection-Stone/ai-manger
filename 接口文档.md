# AI-MVP 接口文档（API & Function-Call）

本文件导出项目主要模块的接口与描述，覆盖 `ai-context`、`chat-main`、`function-call/analysis`。

## 目录
- AI-Context 检索接口
- Chat-Main 对话接口
- Function-Call Analysis 工具
- Module Tip 映射（关键词/文件/函数哈希）

---

## AI-Context 检索接口
- 基础路径: `/context/retrieval`
- 控制器: `src/modules/ai-context/controller/retrieval.controller.ts:11`
- 服务: `src/modules/ai-context/services/retrieval.service.ts`

### GET `/context/retrieval/:sessionId`
- 描述: 通过关键词获取滑动窗口上下文
- 参数（Query）:
  - `keywords`: 逗号分隔关键词字符串，如 `k1,k2`
  - `matchAll`: 是否要求全部命中（`true|false`）
  - `windowSize`: 每个命中点左右扩展的窗口大小（默认 3）
  - `max`: 返回的最大消息条数（默认 20）
- 返回: `ContextMessage[]`（按时间排序的上下文消息片段）
- 代码参考:
  - 控制器: `src/modules/ai-context/controller/retrieval.controller.ts:15-40`
  - 滑动窗口实现: `src/modules/ai-context/services/retrieval.service.ts:78-124`
  - 关键词检索: `src/modules/ai-context/services/retrieval.service.ts:54-70`
  - 关键词提取: `src/modules/ai-context/services/keyword.service.ts:46-61`
  - 类型定义: `src/modules/ai-context/types/retrieval.types.ts:7-12`

---

## Chat-Main 对话接口
- 基础路径: `/chat`
- 控制器: `src/modules/chat-main/controller/chat.controller.ts:21`
- 服务: `src/modules/chat-main/services/chat.service.ts`

### POST `/chat/send`
- 描述: 非流式发送接口，返回最终文本与历史消息
- 请求体: `ChatRequest`（`sessionId`, `input`, `provider?`, `model?`, `temperature?`）
- 返回: `ChatResponse`（`text`, `messages`）
- 代码参考: `src/modules/chat-main/controller/chat.controller.ts:25-28`, `src/modules/chat-main/services/chat.service.ts:41-73`

### GET `/chat/stream`
- 描述: SSE 流式接口，返回令牌与最终文本事件
- 查询参数: `sessionId`, `input`, `provider?`, `model?`, `temperature?`
- 返回: `Observable<MessageEvent>`
- 代码参考: `src/modules/chat-main/controller/chat.controller.ts:30-39`, `src/modules/chat-main/services/chat.service.ts:81-130`

### POST `/chat/session`
- 描述: 创建或复用会话，返回 `sessionId`
- 请求体: `sessionId?`
- 返回: `{ sessionId: string }`
- 代码参考: `src/modules/chat-main/controller/chat.controller.ts:41-47`, `src/modules/chat-main/services/chat.service.ts:138-140`

### GET `/chat/messages/:sessionId`
- 描述: 获取会话消息列表
- 返回: `{ messages: unknown[] }`
- 代码参考: `src/modules/chat-main/controller/chat.controller.ts:49-55`, `src/modules/chat-main/services/chat.service.ts:156-161`

### DELETE `/chat/session/:sessionId`
- 描述: 清空会话历史
- 返回: `{ ok: boolean }`
- 代码参考: `src/modules/chat-main/controller/chat.controller.ts:57-63`, `src/modules/chat-main/services/chat.service.ts:163-165`

---

## Function-Call Analysis 工具
- 服务: `src/modules/function-call/analysis/services/analysis.service.ts`
- 模块: `src/modules/function-call/analysis/analysis.module.ts:7-12`

### 工具 `data_analysis`
- 描述: 结合上下文与 Schema 推断最小 Mongo 查询，限制 `limit` 并执行返回 `{ query, rows }`
- 输入（Zod Schema）:
  - `question: string` 分析问题
  - `context?: { role: 'system'|'user'|'assistant'; content: string }[]`
  - `limit?: number` 建议最大行数（默认 20，最大 50）
  - `provider?: 'gemini'|'deepseek'`, `model?: string`
- 句柄获取: `getHandle(): CreateAgentParams['tools']`
- 代码参考: `src/modules/function-call/analysis/services/analysis.service.ts:22-109`

---

## Module Tip 映射（关键词/文件/函数哈希）

### AI-Context
- 文件: `src/modules/ai-context/description/ai-context.tip.ts`
- 关键词（中）: 检索, 关键词, 滑动窗口, 控制器, 服务, 类型
- 关键词（英）: retrieval, keywords, sliding window, controller, service, types
- 文件映射:
  - 检索服务/Service → `src/modules/ai-context/services/retrieval.service.ts`
  - 关键词服务/Keyword → `src/modules/ai-context/services/keyword.service.ts`
  - 检索控制器/Controller → `src/modules/ai-context/controller/retrieval.controller.ts`
  - 检索类型/Types → `src/modules/ai-context/types/retrieval.types.ts`
- 函数哈希（sha256(`path#function`)):
  - `reindexSession` → `src/modules/ai-context/services/retrieval.service.ts#reindexSession`
  - `search` → `src/modules/ai-context/services/retrieval.service.ts#search`
  - `getSlidingContext` → `src/modules/ai-context/services/retrieval.service.ts#getSlidingContext`
  - `extractKeywords` → `src/modules/ai-context/services/keyword.service.ts#extractKeywords`

### Chat-Main
- 文件: `src/modules/chat-main/description/chat-main.tip.ts`
- 关键词（中）: 主对话, 流式, 非流式, 上下文CRUD, 控制器, 服务
- 关键词（英）: chat main, streaming, non-streaming, context CRUD, controller, service
- 文件映射:
  - 控制器/Controller → `src/modules/chat-main/controller/chat.controller.ts`
  - 服务/Service → `src/modules/chat-main/services/chat.service.ts`
  - 类型/Types → `src/modules/chat-main/types/chat.types.ts`
- 函数哈希（sha256(`path#function`)):
  - `send` → `src/modules/chat-main/services/chat.service.ts#send`
  - `stream` → `src/modules/chat-main/services/chat.service.ts#stream`
  - `createSession` → `src/modules/chat-main/services/chat.service.ts#createSession`
  - `appendUser` → `src/modules/chat-main/services/chat.service.ts#appendUser`
  - `appendAssistant` → `src/modules/chat-main/services/chat.service.ts#appendAssistant`
  - `getMessages` → `src/modules/chat-main/services/chat.service.ts#getMessages`
  - `clearSession` → `src/modules/chat-main/services/chat.service.ts#clearSession`

### Function-Call: Analysis
- 文件: `src/modules/function-call/analysis/description/analysis.tip.ts`
- 关键词（中）: 数据分析, 最小查询, Schema, Mongo
- 关键词（英）: data analysis, minimal query, schema, mongo
- 文件映射:
  - 服务/Service → `src/modules/function-call/analysis/services/analysis.service.ts`
  - 模块/Module → `src/modules/function-call/analysis/analysis.module.ts`
- 函数哈希（sha256(`path#function`)):
  - `data_analysis` → `src/modules/function-call/analysis/services/analysis.service.ts#data_analysis`

---

## 验证
- 已通过 `npm run lint` 与 `npm run build`。

